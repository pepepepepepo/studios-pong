<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
    <title>Studios Pong - AI Personas</title>
    <style>
        :root {
            --persona-color: #7B68EE;
        }
        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--persona-color);
            padding-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            color: var(--persona-color);
        }
        .persona-selector {
            margin-bottom: 20px;
        }
        .persona-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .persona-selector select {
            width: 100%;
            padding: 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--persona-color);
            border-radius: 4px;
        }
        .chat-container {
            border: 2px solid var(--persona-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 400px;
            max-height: 400px;
            overflow-y: auto;
            background: var(--vscode-editor-background);
        }
        .message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 6px;
        }
        .message.user {
            background: var(--vscode-inputOption-activeBackground);
            text-align: right;
        }
        .message.persona {
            background: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--persona-color);
        }
        .message .sender {
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--persona-color);
        }
        .message .text {
            line-height: 1.5;
        }
        .message .timestamp {
            font-size: 0.85em;
            color: var(--vscode-descriptionForeground);
            margin-top: 4px;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        .input-container input {
            flex: 1;
            padding: 10px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--persona-color);
            border-radius: 4px;
        }
        .input-container button {
            padding: 10px 20px;
            background: var(--persona-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .input-container button:hover {
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            color: var(--vscode-descriptionForeground);
            padding: 20px;
        }
        .error {
            color: var(--vscode-errorForeground);
            background: var(--vscode-inputValidation-errorBackground);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .favorites-container {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--vscode-textBlockQuote-background);
            border-radius: 8px;
            border: 1px solid var(--persona-color);
        }
        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .favorites-header h3 {
            margin: 0;
            color: var(--persona-color);
            font-size: 0.95em;
        }
        .favorites-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .favorite-btn {
            padding: 8px 14px;
            background: var(--persona-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .favorite-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .favorite-btn .star {
            cursor: pointer;
            font-size: 1.1em;
        }
        .favorites-empty {
            color: var(--vscode-descriptionForeground);
            font-style: italic;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÓÅû Studios Pong</h1>
            <p>Your AI Persona Team - 74 Personalities with Local Memory</p>
        </div>

        <div class="persona-selector">
            <label for="personaSelect">Select AI Persona:</label>
            <select id="personaSelect">
                <option value="">Loading personas...</option>
            </select>
        </div>

        <div class="favorites-container" id="favoritesContainer" style="display: none;">
            <div class="favorites-header">
                <h3>‚≠ê Favorite Personas</h3>
            </div>
            <div class="favorites-buttons" id="favoritesButtons">
                <div class="favorites-empty">Click the star (‚≠ê) after selecting a persona to add it to favorites!</div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div class="memory-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div id="memoryStats" style="color: var(--vscode-descriptionForeground); font-size: 0.9em;">
                üíæ Memory: Loading...
            </div>
            <div>
                <button id="searchMemoryBtn" style="padding: 6px 12px; background: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">üîç Search</button>
                <button id="exportMemoryBtn" style="padding: 6px 12px; background: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">üì• Export</button>
                <button id="importMemoryBtn" style="padding: 6px 12px; background: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">üì§ Import</button>
                <button id="clearMemoryBtn" style="padding: 6px 12px; background: var(--vscode-errorForeground); color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è Clear</button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="loading">Initializing Studios Pong...</div>
        </div>

        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Type your message..." />
            <button id="sendButton">Send</button>
        </div>
        
        <input type="file" id="importFileInput" accept=".json" style="display: none;">
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let currentPersonaId = null;
        let chatHistory = {}; // { personaId: [messages] }
        let favoritePersonas = []; // Array of favorite persona IDs

        // Initialize
        window.addEventListener('load', () => {
            loadChatHistory();
            loadFavoritePersonas();
            updateMemoryStats();
            
            // Request saved history from Extension workspaceState
            vscode.postMessage({ command: 'loadHistory' });
            
            vscode.postMessage({ command: 'getPersonas' });
        });

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.command) {
                case 'personasLoaded':
                    loadPersonas(message.personas);
                    break;
                case 'messageReceived':
                    displayMessage(message.persona, message.message, message.timestamp, false);
                    break;
                case 'error':
                    displayError(message.message);
                    break;
                case 'historyLoaded':
                    // Merge Extension-saved history with WebView state
                    if (message.chatHistory) {
                        chatHistory = message.chatHistory;
                        vscode.setState({ chatHistory: chatHistory });
                        updateMemoryStats();
                        console.log('üíæ Chat history restored from workspace state');
                    }
                    break;
            }
        });

        // Load personas into dropdown
        function loadPersonas(personas) {
            console.log('üîç Received personas:', personas);
            console.log('üîç First persona:', personas[0]);
            
            const select = document.getElementById('personaSelect');
            select.innerHTML = '<option value="">-- Select a Persona --</option>';
            
            // Store personas data for later use
            window.personasData = {};
            
            personas.forEach((persona, index) => {
                // Debug: Log first 3 personas
                if (index < 3) {
                    console.log(`Persona ${index}:`, {
                        id: persona.id,
                        name: persona.name,
                        emoji: persona.emoji,
                        role: persona.role
                    });
                }
                
                // Store full persona data
                window.personasData[persona.id] = persona;
                
                const option = document.createElement('option');
                option.value = persona.id;
                
                // Fallback handling for missing data
                const emoji = persona.emoji || 'ü§ñ';
                let name = persona.name;
                let role = persona.role;
                
                // If name is 'Unknown' or empty, try to generate from ID
                if (!name || name === 'Unknown') {
                    // Convert ID to readable name (e.g., '118_yuri' -> 'Yuri')
                    const processedId = persona.id.replace(/^\d+_/, '').replace(/_/g, ' ');
                    
                    // If ID is purely numeric or empty after processing, use generic name
                    if (!processedId || /^\d+$/.test(processedId)) {
                        name = `Persona ${persona.id}`;
                    } else {
                        name = processedId
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                    }
                }
                
                // If role is 'Unknown' or empty, show ID instead
                if (!role || role === 'Unknown') {
                    role = `ID: ${persona.id}`;
                }
                
                option.textContent = `${emoji} ${name} (${role})`;
                select.appendChild(option);
            });

            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '<div class="loading">Select a persona to start chatting</div>';
            
            // Update favorites UI
            updateFavoritesUI();
        }

        // Persona selection
        document.getElementById('personaSelect').addEventListener('change', (e) => {
            currentPersonaId = e.target.value;
            const chatContainer = document.getElementById('chatContainer');
            if (currentPersonaId) {
                const personaName = e.target.options[e.target.selectedIndex].textContent;
                
                // Apply persona color scheme
                const persona = window.personasData[currentPersonaId];
                if (persona && persona.color_scheme) {
                    document.documentElement.style.setProperty('--persona-color', persona.color_scheme);
                } else {
                    document.documentElement.style.setProperty('--persona-color', '#7B68EE');
                }
                
                // Load existing chat history for this persona
                restoreChatHistory(currentPersonaId);
                
                // Update favorites UI to show add/remove star
                updateFavoritesUI();
            }
        });

        // Send message
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !currentPersonaId) {
                if (!currentPersonaId) {
                    displayError('Please select a persona first');
                }
                return;
            }

            // Display user message
            displayMessage('You', text, new Date().toISOString(), true);
            input.value = '';

            // Get conversation history for context
            const history = chatHistory[currentPersonaId] || [];
            
            // Send to backend with conversation history for context
            try {
                vscode.postMessage({
                    command: 'sendMessage',
                    personaId: currentPersonaId,
                    text: text,
                    conversationHistory: history.slice(-10) // Send last 10 messages for context
                });
            } catch (error) {
                displayError('Failed to send message: ' + error.message);
            }
        }

        function displayMessage(sender, text, timestamp, isUser) {
            const chatContainer = document.getElementById('chatContainer');
            
            // Clear loading message
            if (chatContainer.querySelector('.loading')) {
                chatContainer.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'persona'}`;
            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <div class="text">${text}</div>
                <div class="timestamp">${new Date(timestamp).toLocaleTimeString()}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Save to history
            if (currentPersonaId) {
                saveMessageToHistory(currentPersonaId, sender, text, timestamp, isUser);
            }
        }

        function displayError(errorMessage) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">${errorMessage}</div>`;
        }

        // Favorite Personas Management
        function loadFavoritePersonas() {
            const state = vscode.getState();
            if (state && state.favoritePersonas) {
                favoritePersonas = state.favoritePersonas;
            }
        }

        function saveFavoritePersonas() {
            const state = vscode.getState() || {};
            state.favoritePersonas = favoritePersonas;
            vscode.setState(state);
        }

        function toggleFavorite(personaId) {
            const index = favoritePersonas.indexOf(personaId);
            if (index === -1) {
                // Add to favorites
                favoritePersonas.push(personaId);
            } else {
                // Remove from favorites
                favoritePersonas.splice(index, 1);
            }
            saveFavoritePersonas();
            updateFavoritesUI();
        }

        function updateFavoritesUI() {
            const container = document.getElementById('favoritesContainer');
            const buttonsContainer = document.getElementById('favoritesButtons');
            
            // Show container if there are favorites OR a persona is selected
            if (favoritePersonas.length === 0 && !currentPersonaId) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            buttonsContainer.innerHTML = '';
            
            // Display favorite persona buttons
            favoritePersonas.forEach(personaId => {
                const persona = window.personasData[personaId];
                if (!persona) return;
                
                const button = document.createElement('button');
                button.className = 'favorite-btn';
                button.innerHTML = `
                    <span>${persona.emoji || 'ü§ñ'} ${persona.name}</span>
                    <span class="star" data-persona-id="${personaId}">‚≠ê</span>
                `;
                
                // Click on button (not star) to select persona
                button.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('star')) {
                        selectPersona(personaId);
                    }
                });
                
                // Click on star to remove from favorites
                const star = button.querySelector('.star');
                star.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(personaId);
                });
                
                buttonsContainer.appendChild(button);
            });
            
            // Add "Add Current" button if a persona is selected and not already in favorites
            if (currentPersonaId && !favoritePersonas.includes(currentPersonaId)) {
                const addButton = document.createElement('button');
                addButton.className = 'favorite-btn';
                addButton.style.background = 'var(--vscode-button-secondaryBackground)';
                addButton.style.color = 'var(--vscode-button-secondaryForeground)';
                addButton.innerHTML = '‚òÜ Add Current';
                addButton.addEventListener('click', () => {
                    toggleFavorite(currentPersonaId);
                });
                buttonsContainer.appendChild(addButton);
            }
            
            // If no favorites yet, show a helpful message
            if (favoritePersonas.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'favorites-empty';
                emptyMsg.textContent = 'Click "‚òÜ Add Current" to add this persona to favorites!';
                buttonsContainer.appendChild(emptyMsg);
            }
        }

        function selectPersona(personaId) {
            const select = document.getElementById('personaSelect');
            select.value = personaId;
            select.dispatchEvent(new Event('change'));
        }

        // Chat history persistence functions
        function loadChatHistory() {
            const state = vscode.getState();
            if (state && state.chatHistory) {
                chatHistory = state.chatHistory;
            }
        }

        function updateMemoryStats() {
            const totalPersonas = Object.keys(chatHistory).length;
            const totalMessages = Object.values(chatHistory).reduce((sum, msgs) => sum + msgs.length, 0);
            document.getElementById('memoryStats').textContent = 
                `üíæ Memory: ${totalPersonas} personas, ${totalMessages} messages`;
        }

        function saveMessageToHistory(personaId, sender, text, timestamp, isUser) {
            if (!chatHistory[personaId]) {
                chatHistory[personaId] = [];
            }
            
            chatHistory[personaId].push({
                sender: sender,
                text: text,
                timestamp: timestamp,
                isUser: isUser
            });

            // Persist to VS Code state (WebView level)
            vscode.setState({ chatHistory: chatHistory });
            
            // Also save to Extension workspaceState (persistent across VS Code restarts)
            vscode.postMessage({
                command: 'saveHistory',
                chatHistory: chatHistory
            });
            
            updateMemoryStats();
        }

        function restoreChatHistory(personaId) {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';

            const history = chatHistory[personaId] || [];
            
            if (history.length === 0) {
                const personaName = document.getElementById('personaSelect').options[document.getElementById('personaSelect').selectedIndex].textContent;
                chatContainer.innerHTML = `<div class="loading">Chat with ${personaName} started!</div>`;
            } else {
                history.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.isUser ? 'user' : 'persona'}`;
                    messageDiv.innerHTML = `
                        <div class="sender">${msg.sender}</div>
                        <div class="text">${msg.text}</div>
                        <div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    `;
                    chatContainer.appendChild(messageDiv);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Memory Management Functions
        document.getElementById('searchMemoryBtn').addEventListener('click', () => {
            const searchTerm = prompt('üîç Search in conversation history:');
            if (!searchTerm) return;

            const results = [];
            Object.keys(chatHistory).forEach(personaId => {
                const personaName = window.personasData[personaId]?.name || `Persona ${personaId}`;
                chatHistory[personaId].forEach(msg => {
                    if (msg.text.toLowerCase().includes(searchTerm.toLowerCase())) {
                        results.push({
                            personaId,
                            personaName,
                            ...msg
                        });
                    }
                });
            });

            if (results.length === 0) {
                displayError(`No results found for "${searchTerm}"`);
                return;
            }

            // Display search results
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `<div class="loading">Search Results for "${searchTerm}" (${results.length} found)</div>`;
            
            results.forEach(result => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${result.isUser ? 'user' : 'persona'}`;
                const highlightedText = result.text.replace(
                    new RegExp(searchTerm, 'gi'), 
                    match => `<mark style="background: yellow; color: black;">${match}</mark>`
                );
                messageDiv.innerHTML = `
                    <div class="sender">${result.personaName} - ${result.sender}</div>
                    <div class="text">${highlightedText}</div>
                    <div class="timestamp">${new Date(result.timestamp).toLocaleString()}</div>
                `;
                chatContainer.appendChild(messageDiv);
            });
        });

        document.getElementById('exportMemoryBtn').addEventListener('click', () => {
            const dataStr = JSON.stringify(chatHistory, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `studios-pong-memory-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            // Show confirmation
            displayError('‚úÖ Memory exported successfully!');
            setTimeout(() => {
                document.getElementById('errorContainer').innerHTML = '';
            }, 3000);
        });

        document.getElementById('importMemoryBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });

        document.getElementById('importFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedHistory = JSON.parse(event.target.result);
                    
                    // Merge with existing history
                    Object.keys(importedHistory).forEach(personaId => {
                        if (!chatHistory[personaId]) {
                            chatHistory[personaId] = [];
                        }
                        chatHistory[personaId] = [...chatHistory[personaId], ...importedHistory[personaId]];
                    });
                    
                    vscode.setState({ chatHistory: chatHistory });
                    
                    // Refresh current view if persona is selected
                    if (currentPersonaId) {
                        restoreChatHistory(currentPersonaId);
                    }
                    
                    displayError('‚úÖ Memory imported successfully!');
                    setTimeout(() => {
                        document.getElementById('errorContainer').innerHTML = '';
                    }, 3000);
                } catch (error) {
                    displayError('‚ùå Failed to import memory: Invalid file format');
                }
            };
            reader.readAsText(file);
            
            // Reset input
            e.target.value = '';
        });

        document.getElementById('clearMemoryBtn').addEventListener('click', () => {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL conversation history? This cannot be undone!')) {
                chatHistory = {};
                vscode.setState({ chatHistory: chatHistory });
                
                // Also clear Extension workspaceState
                vscode.postMessage({ command: 'clearHistory' });
                
                updateMemoryStats();
                
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '<div class="loading">Memory cleared. Select a persona to start fresh!</div>';
                
                displayError('‚úÖ All memory has been cleared');
                setTimeout(() => {
                    document.getElementById('errorContainer').innerHTML = '';
                }, 3000);
            }
        });
    </script>
</body>
</html>


